<!-- Profile Row -->
<div class='d-flex justify-content-between align-items-center mx-3 my-2'>
    <ion-avatar class='mr-3 avatar'>
        <img matListAvatar [src]="post.author.profilePic" [routerLink]="['/app', 'profile', post.author.username]"/>
    </ion-avatar>

    <h3 class='mb-0' [routerLink]="['/app', 'profile', post.author.username]"><ion-text color='dark'>{{post.author.username}}</ion-text></h3>
    <!-- Update to check if user following author -->
    <a mat-button color="accent" (click)="followUser(post.author.id)" *ngIf="!isFollowed"><ion-text color='dark'>Follow</ion-text></a>

    <div class='ml-auto text-right'>
        <ion-text *ngIf="post.repost" color='dark'><i class="ti-reload"></i></ion-text>

        <span class="post-datetime"><ion-text color='medium'>{{ post.createdAt | dateDiff }}</ion-text></span>

        <ion-text color='dark'><i *ngIf="!post.repost" class="ti-menu-alt ml-3" [matMenuTriggerFor]="menu"></i></ion-text>

        <!-- Post Menu -->
        <mat-menu #menu="matMenu" class="mat-elevation-z2">
            <button mat-menu-item *ngIf="post.author.id == user.id" (click)="deletePost()">
                <ion-text color='dark'><i class="ti-trash"></i> Delete</ion-text>
            </button>
            <button mat-menu-item *ngIf="post.author.id !== user.id" (click)="reportPost()">
                <ion-text color='dark'><i class="ti-flag"></i> Report</ion-text>
            </button>
            <button mat-menu-item  (click)="copyURL()">
                <ion-text color='dark'><i class="ti-link"></i> Copy Link</ion-text>
            </button>
        </mat-menu>
    </div>
</div>

<!-- Post Content -->
<div *ngIf="post.type.startsWith('image')">
    <!-- Caption Row -->
    <span *ngIf="post.caption && displayRepost">
        <ion-text color='dark'><p class="mat-body">{{post.caption}}</p></ion-text>
    </span>

    <!-- Post Media -->
    <img class="w-100 m-0" [src]="post.media" (dblclick)="likePost($event)"/>
</div>

<!-- Post Media -->
<div *ngIf="post.type.startsWith('video')">
    <!-- Caption Row -->
    <span *ngIf="post.caption && displayRepost">
        <ion-text color='dark'>
            <p class="mat-body"><span [innerHTML]="post.caption | tag" appRouteTransformer></span></p>
        </ion-text>
    </span>

    <!-- Post Media -->
    <video class="post-image"
        (dblclick)="likePost($event)"
        playsinline
        loop
        controls
        disablePictureInPicture
        controlsList="nofullscreen nodownload"
        preload="metadata">
        <source class="post-image"
            src="{{post.media}}#t=0.001"
            [type]="post.type"/>
    </video>
</div>

<div *ngIf="post.type == 'text' && (!post.repost || !displayRepost)">
    <mat-divider></mat-divider>
    <!-- Caption as Post -->
    <span class="text-post-container" (dblclick)="likePost($event)">
        <ion-text color='dark'>
            <span class="text-post my-3"
                [class.text-post-concat]="post.concat"
                (click)="post.concat = !post.concat"
                [innerHTML]="post.caption | tag"
                appRouteTransformer></span>
        </ion-text>
    </span>
    <mat-divider *ngIf="displayRepost"></mat-divider>
</div>

<div *ngIf="post.type.startsWith('url')">
    <!-- Caption Row -->
    <span *ngIf="post.caption && displayRepost">
        <ion-text color='dark'><p class="mat-body">{{post.caption}}</p></ion-text>
    </span>

    <!-- URL Preview -->
    <a [href]="mediaPreview?.url" target="_blank" (dblclick)="likePost($event)">
        <mat-card *ngIf="mediaPreview">
            <mat-card-header *ngIf="mediaPreview?.title" class="d-flex">
                <mat-card-title class="d-flex justify-content-between">{{ mediaPreview?.title }} <i class="d-flex ti-link"></i></mat-card-title>
            </mat-card-header>

            <mat-divider *ngIf="mediaPreview?.title"></mat-divider>

            <img *ngIf="mediaPreview?.image" mat-card-image [src]="mediaPreview?.image" [alt]="mediaPreview?.title">

            <mat-card-content  *ngIf="mediaPreview?.description">
                <ion-text color='dark'><p class="mt-3">{{ mediaPreview?.description }}</p></ion-text>
            </mat-card-content>
        </mat-card>
    </a>
</div>

<div *ngIf="post.type == 'text' && post.repost && displayRepost">
    <!-- Caption Row -->
    <span *ngIf="post.caption" class="mb-2">
        <ion-text color='dark'><p class="mat-body m-0">{{post.caption}}</p></ion-text>
    </span>
</div>

<div *ngIf="post.repost && displayRepost"
    class="px-3 py-0 my-0"
    [routerLink]="['/app', 'post', post.repostOf.id]" >
    <div class="mat-card p-0">
        <span class="mat-card-content repost">
            <app-post-display
                [post]="post.repostOf"
                [user]="user"
                [isFollowed]="true"
                [displayRepost]="false"></app-post-display>
        </span>
    </div>
</div>